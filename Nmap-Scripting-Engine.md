# Nmap Scripting Engine

By Kaushal Banninthaya

[@kaushal_k](https://twitter.com/kaushal_k) | kaushal.1991@gmail.com | [GitHub](https://github.com/feralfenrir)

<!-- MarkdownTOC -->

- Nmap Scripting Engine
    - Why script?
    - Current NSE Scripts
    - Script Format
    - Writing a simple script

<!-- /MarkdownTOC -->

## Nmap Scripting Engine

### Why script?

Scripts automate a wide variety of networking tasks. These scripts are then executed in parallel with the speed and efficiency you expect from Nmap. Users can rely on the growing and diverse set of scripts distributed with Nmap, or write their own to meet custom needs like:

- Network discovery
- More sophisticated version detection
- Vulnerability detection
- Backdoor detection
- Vulnerability exploitation

Scripts are written in the embedded Lua programming language, version 5.2.

**Typical NSE output:**

```
nmap -sC -p22,111,139 -T4 localhost

Starting Nmap ( https://nmap.org )
Nmap scan report for flog (127.0.0.1)
PORT     STATE SERVICE
22/tcp   open  ssh
| ssh-hostkey: 1024 b1:36:0d:3f:50:dc:13:96:b2:6e:34:39:0d:9b:1a:38 (DSA)
|_2048 77:d0:20:1c:44:1f:87:a0:30:aa:85:cf:e8:ca:4c:11 (RSA)
111/tcp  open  rpcbind
| rpcinfo:  
| 100000  2,3,4    111/udp  rpcbind  
| 100024  1      56454/udp  status   
|_100000  2,3,4    111/tcp  rpcbind  
139/tcp  open  netbios-ssn

Host script results:
| smb-os-discovery: Unix
| LAN Manager: Samba 3.0.31-0.fc8
|_Name: WORKGROUP

Nmap done: 1 IP address (1 host up) scanned in 0.33 seconds
```

### Current NSE Scripts

NSE scripts define a list of categories they belong to. Currently defined categories are auth, broadcast, brute, default. discovery, dos, exploit, external, fuzzer, intrusive, malware, safe, version, and vuln. Category names are not case sensitive.

List of current collection of NSE scripts: <https://nmap.org/nsedoc/>

### Script Format

NSE scripts consist of a handful of descriptive fields, a rule defining when the script should be executed, and an action function containing the actual script instructions. Values can be assigned to the descriptive fields just as you would assign any other Lua variables. Their names must be lowercase as shown in this section.

`description` Field
```
description = [[
Performs a HEAD request for the root folder ("/") of a web server and displays the HTTP headers returned.
]]
```

`categories` Field
`categories = {"default", "discovery", "safe"}`

`author` Field

`license` Field

`dependencies` Field

**Rules**

Nmap uses the script rules to determine whether a script should be run against a target. A rule is a Lua function that returns either true or false. The script action function is only performed if the rule evaluates to true.

A script must contain one or more of the following functions that determine when the script will be run:

- prerule()
- hostrule(host)
- portrule(host, port)
- postrule()

**Action**

The action is the heart of an NSE script. It contains all of the instructions to be executed when the script's prerule, portrule, hostrule or postrule triggers. It is a Lua function which accepts the same arguments as the rule. The return value of the action value may be a table of nameâ€“value pairs, a string, or nil.

**NSE Libraries**

In addition to the significant built-in capabilities of Lua, Nmap has integrated many extension libraries which make script writing more powerful and convenient. These libraries (sometimes called modules) are compiled if necessary and installed along with Nmap. They have their own directory, nselib, which is installed in the configured Nmap data directory. Scripts need only require the default libraries in order to use them.

**Nmap API**

NSE scripts have access to several Nmap facilities for writing flexible and elegant scripts. The API provides target host details such as port states and version detection results. It also offers an interface to the Nsock library for efficient network I/O.

### Writing a simple script

Based on this tutorial: <http://thesprawl.org/research/writing-nse-scripts-for-vulnerability-scanning/>

**Skeleton Code**

```
-- The Head Section --
-- The Rule Section --
portrule = function(host, port)
    return port.protocol == "tcp"
            and port.number == 80
            and port.state == "open"
end

-- The Action Section --
action = function(host, port)
    return "Hello world!"
end
```

`nmap --script null-nmap-humla.nse <IP_address> -p 22,80,443`

```
local shortport = require "shortport"

-- The Rule Section --
portrule = shortport.http

-- The Action Section --
action = function(host, port)
    return "Hello world!"
end
```

**Service Detection**

```
local shortport = require "shortport"
local http = require "http"

-- The Rule Section --
portrule = shortport.http

-- The Action Section --
action = function(host, port)

    local uri = "/"
    local response = http.get(host, port, uri)
    return response.status

end
```

```
local shortport = require "shortport"
local http = require "http"

-- The Rule Section --
portrule = shortport.http

-- The Action Section --
action = function(host, port)

    local uri = "/"
    local response = http.get(host, port, uri)

    if ( response.status == 200 ) then
        return response.body
    end

end
```

**Vulnerability Detection**

```
local shortport = require "shortport"
local http = require "http"
local string = require "string"

-- The Rule Section --
portrule = shortport.http

-- The Action Section --
action = function(host, port)

    local uri = "/"
    local text1 = "Warning: Never expose this VM to an untrusted network!"
    local response = http.get(host, port, uri)

    if ( response.status == 200 ) then
        local bodystr = string.match(response.body, text1)
        return bodystr
    end

end
```

```
local shortport = require "shortport"
local http = require "http"
local string = require "string"

-- The Rule Section --
portrule = shortport.http

-- The Action Section --
action = function(host, port)

    local uri = "/"
    local text1 = "Warning: Never expose this VM to an untrusted network!"
    local response = http.get(host, port, uri)

    if ( response.status == 200 ) then
        local bodystr = string.match(response.body, text1)

        if ( bodystr == text1 ) then
            return "Metasploitable 2 Detected"
        else        
            return "Unknown"
        end
    end
end
```

**Adding a bit of stealth**

```
local shortport = require "shortport"
local http = require "http"
local stdnse = require "stdnse"
local string = require "string"

-- The Rule Section --
portrule = shortport.http

-- The Action Section --
action = function(host, port)

    local uri = "/"
    local text1 = "Warning: Never expose this VM to an untrusted network!"
    local options = {header={}}
    options['header']['User-Agent'] = "Mozilla/5.0"

    local response = http.get(host, port, uri, options)

    if ( response.status == 200 ) then
        local bodystr = string.match(response.body, text1)

        if ( bodystr == text1 ) then
            return "Metasploitable 2 Detected"
        else        
            return "Unknown"
        end
    end
end
```

**Packaging the Script**

```
-- The Head Section --
description = [[Sample script to detect a Metasploitable 2 instance running a web server]]

---
-- @usage
-- nmap --script null-nmap-humla <target>
-- @output
-- PORT   STATE SERVICE
-- 80/tcp open  http
-- |_null-nmap-humla: Metasploitable 2 Detected

author = "nullblr"
license = "Same as Nmap--See http://nmap.org/book/man-legal.html"
categories = {"default", "safe"}

local shortport = require "shortport"
local http = require "http"
local stdnse = require "stdnse"
local string = require "string"

-- The Rule Section --
portrule = shortport.http

-- The Action Section --
action = function(host, port)

    local uri = "/"
    local text1 = "Warning: Never expose this VM to an untrusted network!"
    local options = {header={}}
    options['header']['User-Agent'] = "Mozilla/5.0"

    local response = http.get(host, port, uri, options)

    if ( response.status == 200 ) then
        local bodystr = string.match(response.body, text1)

        if ( bodystr == text1 ) then
            return "Metasploitable 2 Detected"
        else        
            return "Unknown"
        end
    end
end
```
