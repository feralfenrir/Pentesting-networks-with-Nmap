# Null Humla - Pentesting with Nmap

By Kaushal Banninthaya

[@kaushal_k](https://twitter.com/kaushal_k) | kaushal.1991@gmail.com | [GitHub](https://github.com/feralfenrir)

<!-- MarkdownTOC -->

- Installation and Setup of the Lab
- Basics - TCP and UDP
    - TCP Packet Format
    - UDP Packet Format
- Port Scanning
- Nmap
    - Open, Closed and Filtered
- Nmap Options Summary
    - Specifying Targets and Ports
    - Host Discovery
    - Scan Types
    - Service Fingerprinting
    - OS Fingerprinting
    - Script Scanning
    - Scan Output
    - Firewall Evasion
    - Miscellaneous
- Zenmap

<!-- /MarkdownTOC -->

## Installation and Setup of the Lab

- `Metasploitable 2` on `VirtualBox`
    + Download `Metasploitable 2` from [here](https://sourceforge.net/projects/metasploitable/files/Metasploitable2/).
    + Download `VirtualBox` from [here](https://www.virtualbox.org/wiki/Downloads).
    + Follow this [tutorial](http://resources.infosecinstitute.com/running-metasploitable2-on-virtualbox/) to get `Metasploitable 2` running on `VirtualBox`
- `Nmap`
    + Download `Nmap` from [here](https://nmap.org/download.html).
- `Wireshark`
    + Download `Wireshark` from [here](https://www.wireshark.org/download.html).

## Basics - TCP and UDP

### TCP Packet Format
*Source:* <https://www.ietf.org/rfc/rfc793.txt>

```
    0                   1                   2                   3   
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |          Source Port          |       Destination Port        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                        Sequence Number                        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                    Acknowledgment Number                      |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  Data |           |U|A|P|R|S|F|                               |
   | Offset| Reserved  |R|C|S|S|Y|I|            Window             |
   |       |           |G|K|H|T|N|N|                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |           Checksum            |         Urgent Pointer        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                    Options                    |    Padding    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                             data                              |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

                            TCP Header Format
          Note that one tick mark represents one bit position.
```

**Source Port** (16 bits): The source port number.

**Destination Port** (16 bits): The destination port number.

**Sequence Number** (32 bits): The sequence number of the first data octet in this segment (except when SYN is present). If SYN is present the sequence number is the initial sequence number (ISN) and the first data octet is ISN+1.

**Acknowledgment Number** (32 bits): If the ACK control bit is set this field contains the value of the next sequence number the sender of the segment is expecting to receive. Once a connection is established this is always sent.

**Data Offset** (4 bits): The number of 32 bit words in the TCP Header.  This indicates where the data begins.  The TCP header (even one including options) is an integral number of 32 bits long.

**Reserved** (6 bits): Reserved for future use.  Must be zero.

**Control Bits** (6 bits): (from left to right):
    URG:  Urgent Pointer field significant
    ACK:  Acknowledgment field significant
    PSH:  Push Function
    RST:  Reset the connection
    SYN:  Synchronize sequence numbers
    FIN:  No more data from sender

**Window** (16 bits): The number of data octets beginning with the one indicated in the acknowledgment field which the sender of this segment is willing to accept.

**Checksum** (16 bits): The checksum field is the 16 bit one's complement of the one's complement sum of all 16 bit words in the header and text.  If a segment contains an odd number of header and text octets to be checksummed, the last octet is padded on the right with zeros to form a 16 bit word for checksum purposes. The pad is not transmitted as part of the segment.  While computing the checksum, the checksum field itself is replaced with zeros.

The checksum also covers a 96 bit pseudo header conceptually prefixed to the TCP header.  This pseudo header contains the Source Address, the Destination Address, the Protocol, and TCP length. This gives the TCP protection against misrouted segments. This information is carried in the Internet Protocol and is transferred across the TCP/Network interface in the arguments or results of calls by the TCP on the IP.

```
                     +--------+--------+--------+--------+
                     |           Source Address          |
                     +--------+--------+--------+--------+
                     |         Destination Address       |
                     +--------+--------+--------+--------+
                     |  zero  |  PTCL  |    TCP Length   |
                     +--------+--------+--------+--------+

      The TCP Length is the TCP header length plus the data length in
      octets (this is not an explicitly transmitted quantity, but is
      computed), and it does not count the 12 octets of the pseudo
      header.
```

### UDP Packet Format
*Source:* <https://www.ietf.org/rfc/rfc768.txt>

```
                  0      7 8     15 16    23 24    31  
                 +--------+--------+--------+--------+ 
                 |     Source      |   Destination   | 
                 |      Port       |      Port       | 
                 +--------+--------+--------+--------+ 
                 |                 |                 | 
                 |     Length      |    Checksum     | 
                 +--------+--------+--------+--------+ 
                 |                                     
                 |          data octets ...            
                 +---------------- ...                 

                      User Datagram Header Format
```

**Source Port** is an optional field, when meaningful, it indicates the port
of the sending  process,  and may be assumed  to be the port  to which a
reply should  be addressed  in the absence of any other information.  If
not used, a value of zero is inserted.

**Destination  Port** has a meaning  within  the  context  of  a  particular
internet destination address.

**Length**  is the length  in octets  of this user datagram  including  this
header  and the data.   (This  means  the minimum value of the length is
eight.)

**Checksum** is the 16-bit one's complement of the one's complement sum of a
pseudo header of information from the IP header, the UDP header, and the
data,  padded  with zero octets  at the end (if  necessary)  to  make  a
multiple of two octets.

The pseudo  header  conceptually prefixed to the UDP header contains the
source  address,  the destination  address,  the protocol,  and the  UDP
length.   This information gives protection against misrouted datagrams.
This checksum procedure is the same as is used in TCP.

```
                  0      7 8     15 16    23 24    31 
                 +--------+--------+--------+--------+
                 |          source address           |
                 +--------+--------+--------+--------+
                 |        destination address        |
                 +--------+--------+--------+--------+
                 |  zero  |protocol|   UDP length    |
                 +--------+--------+--------+--------+
```

If the computed  checksum  is zero,  it is transmitted  as all ones (the
equivalent  in one's complement  arithmetic).   An all zero  transmitted
checksum  value means that the transmitter  generated  no checksum  (for
debugging or for higher level protocols that don't care).

## Port Scanning

`nc -z -v host portrange`

## Nmap

[Nmap ("Network Mapper")](https://nmap.org/) is a free and open source most widely used utility for network discovery and security auditing.

Nmap uses raw IP packets to determine:

- What hosts are available on the network
- What services (application name and version) those hosts are offering
- What operating systems (and OS versions) they are running
- What type of packet filters/firewalls are in use
- It was designed to rapidly scan large networks, but works fine against single hosts.
- Nmap runs on all major computer operating systems, and official binary packages are available for Linux, Windows, and Mac OS X.

In addition to the classic command-line Nmap executable, the Nmap suite includes an advanced GUI and results viewer (Zenmap), a flexible data transfer, redirection, and debugging tool (Ncat), a utility for comparing scan results (Ndiff), and a packet generation and response analysis tool (Nping).

### Open, Closed and Filtered

**Open Ports**
An application is actively accepting TCP connections or UDP datagrams on this port.

![When servers respond](https://hackertarget.com/firewall-allows-web-traffic.png)

**Filtered Ports**
Nmap cannot determine whether the port is open because packet filtering prevents its probes from reaching the port.

![When the firewall drops a packet](https://hackertarget.com/firewall-filtered-port.png)

**Closed Ports**
A closed port is accessible (it receives and responds to Nmap probe packets), but there is no application listening on it.

![When the firewall fails](https://hackertarget.com/firewall-closed-port.png)

**open|filtered**
Nmap places ports in this state when it is unable to determine whether a port is open or filtered. This occurs for scan types in which open ports give no response.

## Nmap Options Summary

*Source:* <https://svn.nmap.org/nmap/docs/nmap.usage.txt>

### Specifying Targets and Ports

You can pass hostnames, IP addresses, ranges and networks.
Ex: scanme.nmap.org, 192.168.56.100, 192.168.56.100-200, 192.168.56.0/24, 10.0.0,1,3-7

`-iL <filename>`: Pass a list of hosts.
The input file may contain comments that start with # and extend to the end of the line.
`-iR <numberofhosts>`: Choose random targets.
Undesirable IPs such as those in certain private, multicast, or unallocated address ranges are automatically skipped. The argument 0 can be specified for a never-ending scan. `nmap -Pn -sS -p 80 -iR 0 --open` to locate random web servers for browsing.
`--exclude host1, host2, network1`: Exclude hosts/networks.
`--excludefile <filename>`: Exclude list from file.

`-p <port ranges>` (Only scan specified ports)
Ex: `-p-`, `-p U:53,111,137,T:21-25,80,139,8080`, `-p22` or `-p1-1023`
`--exclude-ports <port ranges>` (Exclude the specified ports from scanning)
`--top-ports <n>`
Scans the <n> highest-ratio ports found in nmap-services file

### Host Discovery

Identifying and discovering a host is the first step in nmap’s scanning methodology. In pentesting, we need to reduce a (sometimes huge) set of IP ranges into a list of active or interesting hosts.

If no host discovery options are given, Nmap sends an ICMP echo request, a TCP SYN packet to port 443, a TCP ACK packet to port 80, and an ICMP timestamp request. (`-PE -PS443 -PA80 -PP`)

`-sL` (List Scan)
Simply lists each host of the network(s) specified, without sending any packets to the target hosts. By default, Nmap still does reverse-DNS resolution on the hosts to learn their hostnames.
`-sn` (No port scan and only ping scan)
`-Pn` (Skip ping scan and treat all host to be live)
`-PS <portlist>` (TCP SYN Ping)
This option sends an empty TCP packet with the SYN flag set. The default destination port is 80.
Ex: `-PS22` and `-PS22-25,80,113,1050,35000`.
Note that there can be no space between -PS and the port list.
`-PA <port list>` (TCP ACK Ping)
This sends a packet with the TCP ACK flag is set instead of the SYN flag. This uses the same default port as the SYN probe (80) and can also take a list of destination ports in the same format. If an unprivileged user tries this, the connect workaround discussed previously is used. This workaround is imperfect because connect is actually sending a SYN packet rather than an ACK.
`-PU <port list>` (UDP Ping)
This sends a UDP packet to the given ports. For most ports, the packet will be empty, though some use a protocol-specific payload that is more likely to elicit a response. Packet content can also be affected with the --data, --data-string, and --data-length options. If no ports are specified, the default is 40125.
An ICMP port unreachable signifies host is up. Other ICMP errors imply host os down. If an open port is reached, most services simply ignore the empty packet and fail to return any response.
`-PE; -PP; -PM` (ICMP Ping Types)
`-PR` (ARP Ping)
`--traceroute` (Trace path to host)
`-n` (No DNS resolution)
`-R` (DNS resolution for all targets)
`--dns-servers server1,server2` (Servers to use for reverse DNS queries)

### Scan Types

Nmap has a plethora of scan techniques and we need to choose the appropriate one (or combination) for a given task.

Most of the scan types are only available to privileged users. This is because they send and receive raw packets, which requires root access on Unix systems. Using an administrator account on Windows is recommended, though Nmap sometimes works for unprivileged users on that platform when WinPcap has already been loaded into the OS.

`-sS` (TCP SYN scan)
SYN scan is the default and most popular scan option for good reasons. It can be performed quickly, scanning thousands of ports per second on a fast network not hampered by restrictive firewalls. It is also relatively unobtrusive and stealthy since it never completes TCP connections.
`-sT` (TCP connect scan)
TCP connect scan is the default TCP scan type when SYN scan is not an option. This is the case when a user does not have raw packet privileges. Instead of writing raw packets as most other scan types do, Nmap asks the underlying operating system to establish a connection with the target machine and port by issuing the connect system call.
`-sU` (UDP scans)
UDP scan is activated with the -sU option. It can be combined with a TCP scan type such as SYN scan (-sS) to check both protocols during the same run. A big challenge with UDP scanning is doing it quickly. Open and filtered ports rarely send any response, leaving Nmap to time out and then conduct retransmissions just in case the probe or response were lost. Closed ports are often an even bigger problem. They usually send back an ICMP port unreachable error. But unlike the RST packets sent by closed TCP ports in response to a SYN or connect scan, many hosts rate limit ICMP port unreachable messages by default.
`-sN; -sF; -sX` (TCP NULL, FIN, and Xmas scans)
RFC 793 says that “if the [destination] port state is CLOSED, an incoming segment not containing a RST causes a RST to be sent in response.
- Null scan (`-sN`): Does not set any bits (TCP flag header is 0)
- FIN scan (`-sF`): Sets just the TCP FIN bit.
- Xmas scan (`-sX`): Sets the FIN, PSH, and URG flags, lighting the packet up like a Christmas tree.
`-sA` (TCP ACK scan)
The ACK scan probe packet has only the ACK flag set.
`--scanflags` (Custom TCP scan)
Truly advanced Nmap users need not limit themselves to the canned scan types offered. The --scanflags option allows you to design your own scan by specifying arbitrary TCP flags.
`-b <FTP relay host>` (FTP bounce scan)
An interesting feature of the FTP protocol (RFC 959) is support for so-called proxy FTP connections. This allows a user to connect to one FTP server, then ask that files be sent to a third-party server. Nmap asks the FTP server to send a file to each interesting port of a target host in turn. The error message will describe whether the port is open or not. It takes an argument of the form `<username>:<password>@<server>:<port>`.

### Service Fingerprinting

Having an accurate version number helps dramatically in determining which exploits a server is vulnerable to. Version detection helps you obtain this information.

Some UDP ports are left in the open|filtered state after a UDP port scan is unable to determine whether the port is open or filtered. Version detection will try to elicit a response from these ports (just as it does with open ports), and change the state to open if it succeeds. open|filtered TCP ports are treated the same way.

`-sV` (Version detection)
`--version-intensity <intensity>` (Set version scan intensity)
The intensity must be between 0 and 9. The default is 7.
`--version-light` (Enable light mode)
An alias for --version-intensity 2.
`--version-all` (Try every single probe)
An alias for --version-intensity 9.

### OS Fingerprinting

Nmap sends a series of TCP and UDP packets to the remote host and examines practically every bit in the responses. After performing dozens of tests such as TCP ISN sampling, TCP options support and ordering, IP ID sampling, and the initial window size check, Nmap compares the results to its nmap-os-db database of more than 2,600 known OS fingerprints and prints out the OS details if there is a match.

`-O` (Enable OS detection)
`--osscan-limit` (Limit OS detection to promising targets)
`--osscan-guess; --fuzzy` (Guess OS detection results)

### Script Scanning

We can perform more powerful pentesting with NSE scripts which are capable of network discovery, more sophisticated version detection, vulnerability detection. NSE can even be used for vulnerability exploitation.

Currently defined categories of NSE scripts are auth, broadcast, default. discovery, dos, exploit, external, fuzzer, intrusive, malware, safe, version, and vuln.

`-sC`
Performs a script scan using the default set of scripts. It is equivalent to `--script=default`.
`--script <filename>|<category>|<directory>`
Runs a script scan using the comma-separated list of filenames, script categories, and directories.
Ex: `nmap --script "http-*"`, `nmap --script "default or safe"` or `nmap --script "not intrusive"`
`--script-args <n1>=<v1>,<n2>={<n3>=<v3>},<n4>={<v4>,<v5>}`
Lets you provide arguments to NSE scripts. Arguments are a comma-separated list of name=value pairs.
`--script-help <filename>|<category>`
Ex: `nmap --script-help ftp-anon`

### Scan Output

`-oN <filespec>` (normal output)
`-oX <filespec>` (XML output)
`-oG <filespec>` (grepable output)
`-oA <basename>` (Output to all formats)

**Bonus:** `-oS <filespec>` (ScRipT KIdd|3 oUTpuT)
Script kiddie output is like interactive output, except that it is post-processed to better suit the l33t HaXXorZ

### Firewall Evasion

`-S <IP_Address>` (Spoof source address)
`--source-port <portnumber>; -g <portnumber>` (Spoof source port number)
`-f` (fragment packets); `--mtu` (using the specified MTU)
The `-f` option causes the requested scan (including ping scans) to use tiny fragmented IP packets. The idea is to split up the TCP header over several packets to make it harder for packet filters, intrusion detection systems, and other annoyances to detect what you are doing.
`-D <decoy1>[,<decoy2>][,ME][,...]` (Cloak a scan with decoys)
Causes a decoy scan to be performed, which makes it appear to the remote host that the host(s) you specify as decoys are scanning the target network too. Separate each decoy host with commas, and you can optionally use ME as one of the decoys to represent the position for your real IP address. If you put ME in the sixth position or later, some common port scan detectors (such as Solar Designer's excellent Scanlogd) are unlikely to show your IP address at all. If you don't use ME, Nmap will put you in a random position.
`--proxies <Comma-separated list of proxy URLs>` (Relay TCP connections through a chain of proxies)
URLs in the format proto://host:port

### Miscellaneous

`--min-hostgroup <numhosts>; --max-hostgroup <numhosts>` (Adjust parallel scan group sizes)
`--min-parallelism <numprobes>; --max-parallelism <numprobes>` (Adjust probe parallelization)
`--min-rtt-timeout <time>, --max-rtt-timeout <time>, --initial-rtt-timeout <time>` (Adjust probe timeouts)
`--max-retries <numtries>` (Specify the maximum number of port scan probe retransmissions)
`--min-rate <number>; --max-rate <number>` (Directly control the scanning rate)
`-T paranoid|sneaky|polite|normal|aggressive|insane` (Set a timing template)
The template names are paranoid (0), sneaky (1), polite (2), normal (3), aggressive (4), and insane (5). The first two are for IDS evasion. Polite mode slows down the scan to use less bandwidth and target machine resources. Normal mode is the default and so -T3 does nothing. Aggressive mode speeds scans up by making the assumption that you are on a reasonably fast and reliable network. Finally insane mode assumes that you are on an extraordinarily fast network or are willing to sacrifice some accuracy for speed.

`-v` (Increase verbosity level) , -v<level> (Set verbosity level)
`--reason` (Host and port state reasons)
`--stats-every <time>` (Print periodic timing stats)
`--open` (Show only open (or possibly open) ports)
`-A` (Aggressive scan options)
This enables OS detection (-O), version scanning (-sV), script scanning (-sC) and traceroute (--traceroute).

**Runtime Interaction**

`v / V`
Increase / decrease the verbosity level

`d / D`
Increase / decrease the debugging Level

`p / P`
Turn on / off packet tracing

`?`
Print a runtime interaction help screen

`Anything else`
Print out a status message

## Zenmap

Zenmap is the official Nmap Security Scanner GUI. It is a multi-platform (Linux, Windows, Mac OS X, BSD, etc.) free and open source application which aims to make Nmap easy for beginners to use while providing advanced features for experienced Nmap users. Frequently used scans can be saved as profiles to make them easy to run repeatedly. A command creator allows interactive creation of Nmap command lines. Scan results can be saved and viewed later. Saved scan results can be compared with one another to see how they differ. The results of recent scans are stored in a searchable database.
